<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏° - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏Ø</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #0f172a; /* Slate 900 - Darkest Background */
            color: #cbd5e1; /* Slate 300 - Light Text */
        }
        
        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-day {
            background-color: #ffffff; /* White - Brightest Day */
            border: 1px solid #e2e8f0; /* Slate 200 */
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .calendar-day:not(.disabled):hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2), 0 4px 10px rgba(0,0,0,0.1);
            border-color: #38bdf8;
        }
        .calendar-day.disabled {
            background-color: #1e293b; /* Slate 800 - Darker Disabled Day */
            color: #64748b; /* Slate 500 */
            border-color: #334155; /* Slate 700 */
        }
        .day-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b; /* Slate 800 for white background */
        }
        .calendar-day.disabled .day-number {
            color: #64748b; /* Slate 500 for disabled background */
        }
        .booked-label {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #ffffff;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-top: 4px;
            display: inline-block;
            animation: pulse-animation 2s infinite;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #38bdf8; /* Sky 400 */
            border-radius: 0.75rem;
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.2);
        }
        .form-input, .form-textarea {
            background-color: #0f172a; /* Slate 900 */
            border: 1px solid #475569; /* Slate 600 */
            color: #cbd5e1; /* Slate 300 */
            border-radius: 0.375rem;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #38bdf8; /* Sky 400 */
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
        }
        .btn-primary {
            background-color: #0ea5e9; /* Sky 500 */
            color: #ffffff;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }
        .btn-primary:hover {
            background-color: #0284c7; /* Sky 600 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #cbd5e1; /* Slate 300 */
            font-weight: 500;
            border: 1px solid #475569; /* Slate 600 */
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }
        .btn-secondary:hover {
             background-color: #475569; /* Slate 600 */
        }
        .time-slot-label {
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            cursor: pointer;
            border-radius: 0.375rem;
            position: relative;
        }
        .time-slot-label input:checked + span {
            background-color: #0ea5e9; /* Sky 500 */
            color: #ffffff;
            border-color: #0ea5e9;
        }
        .time-slot-label.disabled {
            background-color: #1e293b; /* Slate 800 */
            border-color: #334155; /* Slate 700 */
            cursor: not-allowed;
        }
        .time-slot-label.disabled span {
            color: #64748b; /* Slate 500 */
            text-decoration: line-through;
        }
        
        .time-slot-label.blocked {
            background-color: #1e3a8a; /* Blue 900 */
            border-color: #1d4ed8; /* Blue 700 */
            cursor: not-allowed;
        }
        
        .time-slot-label.blocked span {
            color: #93c5fd; /* Blue 300 */
            text-decoration: none;
        }
        
        .time-slot-label.blocked::after {
            content: 'üíª';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
        }
        
        /* Loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Success animations */
        @keyframes success-bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -8px, 0); }
            70% { transform: translate3d(0, -4px, 0); }
            90% { transform: translate3d(0, -2px, 0); }
        }
        
        .success-animation {
            animation: success-bounce 1s ease;
        }
        
        /* Improved form styling */
        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            transition: all 0.3s ease;
        }
        
        .form-input:focus + label,
        .form-textarea:focus + label {
            color: #38bdf8;
        }
        
        /* Better mobile responsiveness */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                font-size: 0.875rem;
            }
            
            .day-number {
                font-size: 1rem;
            }
            
            .booked-label {
                font-size: 0.625rem;
                padding: 2px 6px;
            }
        }
        
        /* Enhanced modal */
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            backdrop-filter: blur(10px);
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-spinner" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex justify-center items-center z-50 backdrop-blur-sm">
        <div class="text-center">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-sky-500 mx-auto mb-4"></div>
            <p class="text-slate-300 text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            <div class="mt-2 text-slate-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 p-4">
            <div class="mb-4">
                <div class="text-6xl mb-2">üìö</div>
                <h1 class="text-3xl md:text-5xl font-bold text-sky-400" style="text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°</h1>
                <p class="text-lg md:text-xl text-slate-400 mt-2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏Ø</p>
                <p class="text-sm text-slate-500 mt-1">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡πÇ‡∏î‡∏¢: ‡∏ô‡∏≤‡∏¢‡∏™‡∏≤‡∏ò‡∏¥‡∏ï ‡∏®‡∏¥‡∏£‡∏¥‡∏ß‡∏±‡∏ä‡∏ô‡πå</p>
                <div class="flex justify-center items-center flex-wrap gap-3 mt-4 text-slate-500 text-xs">
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-white rounded border"></div>
                        <span>‡∏ß‡πà‡∏≤‡∏á</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-500 rounded"></div>
                        <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-900 rounded"></div>
                        <span>‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-slate-600 rounded"></div>
                        <span>‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Actions -->
        <div class="mb-6 flex flex-col md:flex-row gap-4 justify-center items-center">
            <div class="flex gap-2">
                <button id="today-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button id="refresh-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                <button id="stats-btn" class="btn-primary px-4 py-2 rounded-lg text-sm">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <input type="text" id="search-bookings" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á..." class="form-input px-3 py-2 w-full md:w-48 rounded-lg text-sm">
                <button id="clear-search" class="btn-secondary px-3 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
        </div>

        <main id="calendar-container" class="p-6 rounded-xl bg-slate-900/50 border border-slate-700" style="box-shadow: 0 0 20px rgba(56, 189, 248, 0.15);">
            <div class="flex justify-between items-center mb-6">
                <button id="prev-month" class="p-3 rounded-full hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="month-year" class="text-2xl md:text-3xl font-bold text-slate-300"></h2>
                <button id="next-month" class="p-3 rounded-full hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="calendar-grid text-center font-semibold text-slate-400 mb-2">
                <div>‡∏≠‡∏≤.</div><div>‡∏à.</div><div>‡∏≠.</div><div>‡∏û.</div><div>‡∏û‡∏§.</div><div>‡∏®.</div><div>‡∏™.</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </main>
    </div>

    <!-- Main Modal for Booking and Details -->
    <div id="main-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-2 md:p-4 modal-backdrop">
        <div class="modal-content p-4 md:p-6 w-full max-w-3xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl md:text-2xl font-bold text-slate-200 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="modal-date-display"></span></h3>
            
            <div id="existing-bookings-container" class="mb-6">
                <h4 class="text-xl text-slate-300 mb-2 border-b-2 border-slate-600 pb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>
                <div id="existing-bookings-list" class="space-y-3 max-h-40 overflow-y-auto p-1"></div>
            </div>

            <div id="booking-form-container">
                 <h4 class="text-xl text-slate-300 mb-2 border-b-2 border-slate-600 pb-1">‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                 <div id="blocked-info" class="mb-4 p-3 bg-blue-900/30 border border-blue-700 rounded-lg text-blue-200 text-sm hidden">
                    <p class="font-semibold mb-1">üíª ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</p>
                    <div id="blocked-periods-list"></div>
                    <p class="text-xs mt-2 text-blue-300">* ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ</p>
                 </div>
                <form id="booking-form" class="mt-4">
                    <div class="mb-4">
                        <label class="block text-lg text-slate-400 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="time-slots-container"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 my-4">
                        <button type="button" id="select-all-day" class="btn-secondary p-2 text-sm">‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</button>
                        <button type="button" id="select-morning" class="btn-secondary p-2 text-sm">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤</button>
                        <button type="button" id="select-afternoon" class="btn-secondary p-2 text-sm">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢</button>
                        <button type="button" id="clear-selection" class="btn-secondary p-2 text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                     <div class="mb-4">
                        <label for="custom-time" class="block text-lg text-slate-400 mb-2">‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á</label>
                        <input type="text" id="custom-time" name="custom-time" class="form-input w-full p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 9.00-11.30 ‡∏ô.">
                    </div>
                    <div class="form-group">
                        <label for="activity" class="block text-lg text-slate-400 mb-2">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° *</label>
                        <textarea id="activity" name="activity" rows="3" class="form-textarea w-full p-3 rounded-lg" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="teacher" class="block text-lg text-slate-400 mb-2">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• *</label>
                        <input type="text" id="teacher" name="teacher" class="form-input w-full p-3 rounded-lg" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
                    </div>
                    <div class="form-group">
                        <label for="students" class="block text-lg text-slate-400 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                        <input type="text" id="students" name="students" class="form-input w-full p-3 rounded-lg" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 25 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°.1/1">
                    </div>
                    <div class="form-group">
                        <label for="contact" class="block text-lg text-slate-400 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="tel" id="contact" name="contact" class="form-input w-full p-3 rounded-lg" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö">
                    </div>
                    <input type="hidden" id="selected-date-input" name="date">
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="submit" id="submit-booking" class="btn-primary py-2 px-6">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                    </div>
                </form>
            </div>
             <div id="fully-booked-message" class="hidden text-center p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                <p class="font-bold text-lg text-amber-300">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ</p>
            </div>

            <div class="flex justify-end mt-6">
                 <button type="button" id="close-main-modal" class="btn-secondary py-2 px-6">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="stats-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-2 md:p-4 modal-backdrop">
        <div class="modal-content p-4 md:p-6 w-full max-w-6xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl md:text-3xl font-bold text-slate-200">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°</h3>
                <button id="close-stats-modal" class="btn-secondary p-2 rounded-lg">‚úï</button>
            </div>
            
            <!-- Statistics Navigation -->
            <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-600 pb-4">
                <button id="stats-total-btn" class="stats-tab-btn btn-primary px-4 py-2 rounded-lg text-sm">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°</button>
                <button id="stats-yearly-btn" class="stats-tab-btn btn-secondary px-4 py-2 rounded-lg text-sm">‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
                <button id="stats-monthly-btn" class="stats-tab-btn btn-secondary px-4 py-2 rounded-lg text-sm">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            </div>

            <!-- Loading State -->
            <div id="stats-loading" class="text-center py-8 hidden">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500 mx-auto mb-4"></div>
                <p class="text-slate-300">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</p>
            </div>

            <!-- Statistics Content -->
            <div id="stats-content">
                <!-- Total Statistics -->
                <div id="stats-total-content" class="stats-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-6 rounded-xl border border-blue-700">
                            <h4 class="text-xl font-semibold text-blue-200 mb-2">üìÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                            <div class="text-3xl font-bold text-white mb-1" id="total-bookings">0</div>
                            <div class="text-blue-300 text-sm">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
                            <div class="text-2xl font-semibold text-blue-100 mt-2" id="total-hours">0</div>
                            <div class="text-blue-300 text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-900 to-green-800 p-6 rounded-xl border border-green-700">
                            <h4 class="text-xl font-semibold text-green-200 mb-2">‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                            <div class="text-3xl font-bold text-white mb-1" id="actual-bookings">0</div>
                            <div class="text-green-300 text-sm">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>
                            <div class="text-2xl font-semibold text-green-100 mt-2" id="actual-hours">0</div>
                            <div class="text-green-300 text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-6 rounded-xl border border-blue-700">
                            <h4 class="text-xl font-semibold text-blue-200 mb-2">üíª ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h4>
                            <div class="text-3xl font-bold text-white mb-1" id="blocked-periods">0</div>
                            <div class="text-blue-300 text-sm">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</div>
                            <div class="text-2xl font-semibold text-blue-100 mt-2" id="blocked-hours">0</div>
                            <div class="text-blue-300 text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                        </div>
                    </div>
                </div>

                <!-- Yearly Statistics -->
                <div id="stats-yearly-content" class="stats-content hidden">
                    <div class="mb-4">
                        <label for="year-select" class="block text-slate-300 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ:</label>
                        <select id="year-select" class="form-input p-2 rounded-lg w-48">
                            <!-- Years will be populated dynamically -->
                        </select>
                    </div>
                    <div id="yearly-stats-display" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Yearly stats will be populated here -->
                    </div>
                </div>

                <!-- Monthly Statistics -->
                <div id="stats-monthly-content" class="stats-content hidden">
                    <div class="flex gap-4 mb-4">
                        <div>
                            <label for="month-select" class="block text-slate-300 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                            <select id="month-select" class="form-input p-2 rounded-lg">
                                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-year-select" class="block text-slate-300 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ:</label>
                            <select id="monthly-year-select" class="form-input p-2 rounded-lg">
                                <!-- Years will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div id="monthly-stats-display" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Monthly stats will be populated here -->
                    </div>
                </div>

                <!-- Detailed Statistics Table -->
                <div class="mt-8">
                    <h4 class="text-xl font-semibold text-slate-300 mb-4 border-b border-slate-600 pb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-800">
                                <tr>
                                    <th class="px-6 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th class="px-6 py-3">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                                    <th class="px-6 py-3">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</th>
                                    <th class="px-6 py-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</th>
                                    <th class="px-6 py-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                </tr>
                            </thead>
                            <tbody id="stats-table-body" class="bg-slate-900">
                                <!-- Table rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_eAL5kFkyv95qfLO8KynwJ9Jig1DMw8qMuTzMYfjrWPjePXf520GQRAEKnqtkv_OzLw/exec';
            
            const monthYearEl = document.getElementById('month-year');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const loadingSpinner = document.getElementById('loading-spinner');

            const mainModal = document.getElementById('main-modal');
            const modalDateDisplay = document.getElementById('modal-date-display');
            const closeMainModalBtn = document.getElementById('close-main-modal');
            
            const existingBookingsContainer = document.getElementById('existing-bookings-container');
            const existingBookingsList = document.getElementById('existing-bookings-list');
            const bookingFormContainer = document.getElementById('booking-form-container');
            const fullyBookedMessage = document.getElementById('fully-booked-message');

            const bookingForm = document.getElementById('booking-form');
            const selectedDateInput = document.getElementById('selected-date-input');
            
            let currentMonthDate = new Date();
            let bookings = [];
            let isSubmitting = false;

            // Notification system
            function showNotification(message, type = 'success', duration = 5000) {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
                    </div>
                `;
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }

            // Form validation
            function validateForm() {
                const activity = document.getElementById('activity').value.trim();
                const teacher = document.getElementById('teacher').value.trim();
                const students = document.getElementById('students').value.trim();
                const selectedTimes = document.querySelectorAll('#time-slots-container input[type="checkbox"]:checked');
                const customTime = document.getElementById('custom-time').value.trim();

                if (!activity) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
                    return false;
                }
                if (!teacher) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
                    return false;
                }
                if (!students) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                    return false;
                }
                if (selectedTimes.length === 0 && !customTime) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á', 'error');
                    return false;
                }
                return true;
            }

            // Save form data to localStorage
            function saveFormData() {
                const formData = {
                    activity: document.getElementById('activity').value,
                    teacher: document.getElementById('teacher').value,
                    students: document.getElementById('students').value,
                    contact: document.getElementById('contact').value
                };
                localStorage.setItem('bookingFormData', JSON.stringify(formData));
            }

            // Load form data from localStorage
            function loadFormData() {
                const saved = localStorage.getItem('bookingFormData');
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('activity').value = data.activity || '';
                    document.getElementById('teacher').value = data.teacher || '';
                    document.getElementById('students').value = data.students || '';
                    document.getElementById('contact').value = data.contact || '';
                }
            }

            const timeSlots = [
                { id: 't1', label: '‡∏Ñ‡∏≤‡∏ö 1', time: '8:30-9:20' },
                { id: 't2', label: '‡∏Ñ‡∏≤‡∏ö 2', time: '9:20-10:10' },
                { id: 't3', label: '‡∏Ñ‡∏≤‡∏ö 3', time: '10:10-11:00' },
                { id: 't4', label: '‡∏Ñ‡∏≤‡∏ö 4', time: '11:00-12:00' },
                { id: 't5', label: '‡∏Ñ‡∏≤‡∏ö 5', time: '12:00-12:50' },
                { id: 't6', label: '‡∏Ñ‡∏≤‡∏ö 6', time: '12:50-13:40' },
                { id: 't7', label: '‡∏Ñ‡∏≤‡∏ö 7', time: '13:40-14:30' },
                { id: 't8', label: '‡∏Ñ‡∏≤‡∏ö 8', time: '14:30-15:20' },
                { id: 't9', label: '‡∏Ñ‡∏≤‡∏ö 9', time: '15:20-16:10' },
                { id: 't10', label: '‡∏Ñ‡∏≤‡∏ö 10', time: '16:10-17:00' },
            ];

            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
            const blockedTimeSlots = {
                1: ['t7', 't8'], // ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå: ‡∏Ñ‡∏≤‡∏ö 7-8 (‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
                2: ['t1', 't2', 't5', 't6', 't7', 't8'], // ‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£: ‡∏Ñ‡∏≤‡∏ö 1-2 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 5-8 (‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
                3: ['t6', 't7', 't9', 't10'], // ‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò: ‡∏Ñ‡∏≤‡∏ö 6-7 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 9-10 (‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
                5: ['t1', 't2', 't3', 't7', 't8', 't9'] // ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå: ‡∏Ñ‡∏≤‡∏ö 1-3 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 7-9 (‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)
            };

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            function isTimeSlotBlocked(date, slotId) {
                const dayOfWeek = new Date(date).getDay();
                return blockedTimeSlots[dayOfWeek] && blockedTimeSlots[dayOfWeek].includes(slotId);
            }

            function generateTimeSlots() {
                const container = document.getElementById('time-slots-container');
                container.innerHTML = '';
                timeSlots.forEach(slot => {
                    const label = document.createElement('label');
                    label.className = 'time-slot-label block rounded-md text-center p-2';
                    label.innerHTML = `
                        <input type="checkbox" name="time" value="${slot.label} (${slot.time})" class="hidden">
                        <span class="block w-full h-full p-2 rounded-md transition-colors">${slot.label}<br>${slot.time}</span>
                    `;
                    container.appendChild(label);
                });
            }

            // Cache for bookings
            let bookingsCache = null;
            let lastFetchTime = 0;
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            async function fetchBookings(forceRefresh = false) {
                const now = Date.now();
                
                // Use cache if available and not expired
                if (!forceRefresh && bookingsCache && (now - lastFetchTime) < CACHE_DURATION) {
                    bookings = bookingsCache;
                    renderCalendar(currentMonthDate);
                    return;
                }

                loadingSpinner.style.display = 'flex';
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                    const response = await fetch(`${SCRIPT_URL}?t=${now}`, {
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    if (result.status === "success") {
                        bookings = result.data || [];
                        bookingsCache = bookings;
                        lastFetchTime = now;
                    } else {
                        throw new Error(result.message || 'Failed to parse bookings.');
                    }
                    renderCalendar(currentMonthDate);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error', 7000);
                    } else {
                        console.error('Error fetching bookings:', error);
                        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error', 7000);
                    }
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function getBookingSummary(bookingsForDay) {
                if (!bookingsForDay || bookingsForDay.length === 0) {
                    return '';
                }

                // Filter bookings based on search query
                let filteredBookings = bookingsForDay;
                if (searchQuery) {
                    filteredBookings = bookingsForDay.filter(b => 
                        (b.activity && b.activity.toLowerCase().includes(searchQuery)) ||
                        (b.teacher && b.teacher.toLowerCase().includes(searchQuery)) ||
                        (b.students && b.students.toLowerCase().includes(searchQuery)) ||
                        (b.time && b.time.toLowerCase().includes(searchQuery))
                    );
                }

                if (filteredBookings.length === 0 && searchQuery) {
                    return '';
                }

                const allBookedTimes = bookingsForDay.flatMap(b => b.time ? b.time.split(',').map(t => t.trim()) : []);

                if (allBookedTimes.some(t => t.toLowerCase().includes('‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'))) {
                    return searchQuery && filteredBookings.length === 0 ? '' : '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)';
                }
                
                const periodRegex = /‡∏Ñ‡∏≤‡∏ö\s*\d+/g;
                let totalPeriods = 0;
                const seenPeriods = new Set();

                allBookedTimes.forEach(timeString => {
                    const matches = timeString.match(periodRegex);
                    if (matches) {
                        matches.forEach(match => {
                            if (!seenPeriods.has(match)) {
                                seenPeriods.add(match);
                                totalPeriods++;
                            }
                        });
                    }
                });

                if (totalPeriods > 0) {
                    return searchQuery && filteredBookings.length === 0 ? '' : `‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (${totalPeriods} ‡∏Ñ‡∏≤‡∏ö)`;
                }

                if (allBookedTimes.length > 0) {
                    return searchQuery && filteredBookings.length === 0 ? '' : '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'; // Fallback for custom times
                }

                return '';
            }

            function renderCalendar(date) {
                calendarBody.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                monthYearEl.textContent = `${date.toLocaleString('th-TH', { month: 'long' })} ${year + 543}`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                prevMonthBtn.disabled = (new Date(year, month, 1) <= new Date(today.getFullYear(), today.getMonth(), 1));

                for (let i = 0; i < firstDay; i++) {
                    calendarBody.appendChild(document.createElement('div')).className = 'calendar-day disabled';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    const currentDate = new Date(year, month, i);
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    
                    dayEl.className = 'calendar-day p-2 flex flex-col items-start justify-start cursor-pointer';
                    dayEl.dataset.date = dateString;
                    
                    let dayContent = `<span class="day-number">${i}</span>`;
                    const bookingsForDay = bookings.filter(b => b.date === dateString);
                    
                    const summary = getBookingSummary(bookingsForDay);
                    if (summary) {
                        dayContent += `<div class="booked-label">${summary}</div>`;
                    }

                    dayEl.innerHTML = dayContent;
                    
                    if (currentDate < today) {
                        dayEl.classList.add('disabled');
                        dayEl.classList.remove('cursor-pointer');
                    } else {
                        dayEl.addEventListener('click', () => openMainModal(dateString));
                    }
                    calendarBody.appendChild(dayEl);
                }
            }
            
            function openMainModal(dateString) {
                const [y, m, d] = dateString.split('-');
                const dateObj = new Date(y, m - 1, d);
                modalDateDisplay.textContent = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
                selectedDateInput.value = dateString;
                bookingForm.reset();
                loadFormData(); // Load saved form data

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô
                const dayOfWeek = dateObj.getDay();
                const blockedInfo = document.getElementById('blocked-info');
                const blockedPeriodsList = document.getElementById('blocked-periods-list');
                
                if (blockedTimeSlots[dayOfWeek]) {
                    const blockedPeriods = blockedTimeSlots[dayOfWeek].map(slotId => {
                        const slot = timeSlots.find(s => s.id === slotId);
                        return `${slot.label} (${slot.time})`;
                    }).join(', ');
                    
                    blockedPeriodsList.textContent = blockedPeriods;
                    blockedInfo.classList.remove('hidden');
                } else {
                    blockedInfo.classList.add('hidden');
                }

                const bookingsForDay = bookings.filter(b => b.date === dateString);
                const isFullyBooked = bookingsForDay.some(b => b.time && b.time.toLowerCase().includes('‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'));

                const bookedTimeValues = bookingsForDay
                    .flatMap(b => (b.time ? b.time.split(',').map(t => t.trim()) : []));

                document.querySelectorAll('#time-slots-container input[type="checkbox"]').forEach((checkbox, index) => {
                    const label = checkbox.parentElement;
                    const slotId = timeSlots[index].id;
                    const isBlocked = isTimeSlotBlocked(dateString, slotId);
                    const isBooked = bookedTimeValues.includes(checkbox.value);
                    
                    // Reset classes
                    label.classList.remove('disabled', 'blocked');
                    
                    if (isBlocked) {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥
                        checkbox.disabled = true;
                        checkbox.checked = false;
                        label.classList.add('blocked');
                    } else if (isBooked) {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                        checkbox.disabled = true;
                        checkbox.checked = false; 
                        label.classList.add('disabled');
                    } else {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á
                        checkbox.disabled = false;
                        checkbox.checked = false;
                    }
                });

                if (bookingsForDay.length > 0) {
                    existingBookingsList.innerHTML = bookingsForDay.map(b => `
                        <div class="p-3 rounded-lg border border-slate-700 bg-slate-800 text-sm">
                            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${b.time || 'N/A'}</p>
                            <p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${b.activity || 'N/A'}</p>
                            <p><strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong> ${b.teacher || 'N/A'}</p>
                        </div>
                    `).join('');
                    existingBookingsContainer.style.display = 'block';
                } else {
                    existingBookingsList.innerHTML = '<p class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
                    existingBookingsContainer.style.display = 'block';
                }

                if (isFullyBooked) {
                    bookingFormContainer.style.display = 'none';
                    fullyBookedMessage.style.display = 'block';
                } else {
                    bookingFormContainer.style.display = 'block';
                    fullyBookedMessage.style.display = 'none';
                }

                mainModal.style.display = 'flex';
            }

            closeMainModalBtn.addEventListener('click', () => mainModal.style.display = 'none');

            prevMonthBtn.addEventListener('click', () => {
                currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
                renderCalendar(currentMonthDate);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
                renderCalendar(currentMonthDate);
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Prevent double submission
                if (isSubmitting) return;
                isSubmitting = true;
                
                // Validate form
                if (!validateForm()) {
                    isSubmitting = false;
                    return;
                }
                
                // Save form data for future use
                saveFormData();
                
                loadingSpinner.style.display = 'flex';
                
                const formData = new FormData(bookingForm);
                const selectedTimes = formData.getAll('time');
                const customTime = formData.get('custom-time').trim();

                let timeString = selectedTimes.join(', ');
                if (customTime) {
                    timeString = timeString ? `${timeString}, ${customTime}` : customTime;
                }

                const urlEncodedData = new URLSearchParams();
                urlEncodedData.append('date', formData.get('date'));
                urlEncodedData.append('time', timeString);
                urlEncodedData.append('activity', formData.get('activity'));
                urlEncodedData.append('teacher', formData.get('teacher'));
                urlEncodedData.append('students', formData.get('students'));
                urlEncodedData.append('contact', formData.get('contact') || '');

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: urlEncodedData,
                    });
                    
                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    
                    const result = await response.json();
                    if (result.status !== 'success') {
                         throw new Error(result.message || 'Failed to submit booking.');
                    }

                    showNotification('‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! üéâ', 'success');
                    mainModal.style.display = 'none';
                    document.getElementById('calendar-container').classList.add('success-animation');
                    setTimeout(() => {
                        document.getElementById('calendar-container').classList.remove('success-animation');
                    }, 1000);
                    await fetchBookings(true);

                } catch (error) {
                    console.error('Error submitting booking:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error', 7000);
                } finally {
                    loadingSpinner.style.display = 'none';
                    isSubmitting = false;
                }
            });

            // Button helpers
            document.getElementById('select-all-day').addEventListener('click', () => {
                document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach(cb => cb.checked = true);
            });
            document.getElementById('select-morning').addEventListener('click', () => {
                const morningSlots = ['t1', 't2', 't3', 't4'];
                document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach((cb, index) => {
                   if(morningSlots.includes(timeSlots[index].id)) {
                       cb.checked = true;
                   }
                });
            });
            document.getElementById('select-afternoon').addEventListener('click', () => {
                 const afternoonSlots = ['t6', 't7', 't8', 't9'];
                 document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach((cb, index) => {
                    if(afternoonSlots.includes(timeSlots[index].id)) {
                       cb.checked = true;
                   }
                });
            });
            document.getElementById('clear-selection').addEventListener('click', () => {
                document.querySelectorAll('#time-slots-container input').forEach(cb => cb.checked = false);
            });

            // Search functionality
            let searchQuery = '';
            document.getElementById('search-bookings').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderCalendar(currentMonthDate);
            });

            document.getElementById('clear-search').addEventListener('click', () => {
                document.getElementById('search-bookings').value = '';
                searchQuery = '';
                renderCalendar(currentMonthDate);
            });

            // Quick action buttons
            document.getElementById('today-btn').addEventListener('click', () => {
                currentMonthDate = new Date();
                renderCalendar(currentMonthDate);
            });

            document.getElementById('refresh-btn').addEventListener('click', () => {
                showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'success', 2000);
                fetchBookings(true); // Force refresh
            });

            // Auto-save form data while typing
            ['activity', 'teacher', 'students', 'contact'].forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', () => {
                    setTimeout(saveFormData, 500); // Debounce save
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            fetchBookings();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('search-bookings').focus();
                            break;
                    }
                }
                if (e.key === 'Escape' && mainModal.style.display === 'flex') {
                    mainModal.style.display = 'none';
                }
            });

            // Show app install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Show install button if needed
            });

            // Handle offline/online status
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success', 3000);
                    fetchBookings(true);
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏ä', 'error', 5000);
                }
            }

            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);

            // Auto-refresh data every 10 minutes
            setInterval(() => {
                if (navigator.onLine) {
                    fetchBookings();
                }
            }, 10 * 60 * 1000);

            // Statistics functionality
            const statsModal = document.getElementById('stats-modal');
            const closeStatsModalBtn = document.getElementById('close-stats-modal');
            const statsBtn = document.getElementById('stats-btn');
            const statsLoading = document.getElementById('stats-loading');

            // Statistics calculation functions
            function countPeriodsInTimeString(timeString) {
                if (!timeString) return 0;
                
                // Check for full day booking
                if (timeString.toLowerCase().includes('‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô')) {
                    return 10; // All 10 periods
                }
                
                // Count individual periods (‡∏Ñ‡∏≤‡∏ö 1, ‡∏Ñ‡∏≤‡∏ö 2, etc.)
                const periodRegex = /‡∏Ñ‡∏≤‡∏ö\s*\d+/g;
                const matches = timeString.match(periodRegex);
                if (matches) {
                    return matches.length;
                }
                
                // For custom time entries, estimate based on common patterns
                if (timeString.includes('-')) {
                    // Try to parse time ranges like "9:00-11:00"
                    const timeRanges = timeString.split(',');
                    let totalHours = 0;
                    
                    timeRanges.forEach(range => {
                        const trimmedRange = range.trim();
                        if (trimmedRange.includes('-')) {
                            // Rough estimation: assume each custom time range is about 1-2 hours
                            totalHours += 1;
                        }
                    });
                    
                    return Math.max(1, totalHours); // At least 1 hour
                }
                
                return 1; // Default to 1 hour for any other format
            }

            function calculateBlockedHoursForDateRange(startDate, endDate) {
                let totalBlockedHours = 0;
                const currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    const dayOfWeek = currentDate.getDay();
                    if (blockedTimeSlots[dayOfWeek]) {
                        totalBlockedHours += blockedTimeSlots[dayOfWeek].length;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                return totalBlockedHours;
            }

            function calculateStatistics(bookingsData, startDate = null, endDate = null) {
                let filteredBookings = bookingsData;
                
                // Filter by date range if provided
                if (startDate && endDate) {
                    filteredBookings = bookingsData.filter(booking => {
                        const bookingDate = new Date(booking.date);
                        return bookingDate >= startDate && bookingDate <= endDate;
                    });
                }
                
                let totalActualBookings = 0;
                let totalActualHours = 0;
                
                filteredBookings.forEach(booking => {
                    const hours = countPeriodsInTimeString(booking.time);
                    totalActualBookings += 1;
                    totalActualHours += hours;
                });
                
                // Calculate blocked hours for the date range
                let totalBlockedHours = 0;
                if (startDate && endDate) {
                    totalBlockedHours = calculateBlockedHoursForDateRange(startDate, endDate);
                } else {
                    // Calculate blocked hours for all dates that have bookings
                    const uniqueDates = [...new Set(bookingsData.map(b => b.date))];
                    uniqueDates.forEach(dateString => {
                        const date = new Date(dateString);
                        const dayOfWeek = date.getDay();
                        if (blockedTimeSlots[dayOfWeek]) {
                            totalBlockedHours += blockedTimeSlots[dayOfWeek].length;
                        }
                    });
                }
                
                return {
                    actualBookings: totalActualBookings,
                    actualHours: totalActualHours,
                    blockedPeriods: Math.floor(totalBlockedHours), // Convert to number of blocked periods
                    blockedHours: totalBlockedHours,
                    totalBookings: totalActualBookings + Math.floor(totalBlockedHours),
                    totalHours: totalActualHours + totalBlockedHours,
                    bookingsData: filteredBookings
                };
            }

            function populateYearSelectors() {
                const yearSelects = [document.getElementById('year-select'), document.getElementById('monthly-year-select')];
                const currentYear = new Date().getFullYear();
                const years = [];
                
                // Get years from bookings data
                bookings.forEach(booking => {
                    const year = new Date(booking.date).getFullYear();
                    if (!years.includes(year)) {
                        years.push(year);
                    }
                });
                
                // Add current year if not present
                if (!years.includes(currentYear)) {
                    years.push(currentYear);
                }
                
                years.sort((a, b) => b - a); // Sort descending
                
                yearSelects.forEach(select => {
                    select.innerHTML = '';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year + 543; // Convert to Buddhist Era
                        if (year === currentYear) option.selected = true;
                        select.appendChild(option);
                    });
                });
            }

            function displayTotalStatistics() {
                const stats = calculateStatistics(bookings);
                
                document.getElementById('total-bookings').textContent = stats.totalBookings.toLocaleString();
                document.getElementById('total-hours').textContent = stats.totalHours.toLocaleString();
                document.getElementById('actual-bookings').textContent = stats.actualBookings.toLocaleString();
                document.getElementById('actual-hours').textContent = stats.actualHours.toLocaleString();
                document.getElementById('blocked-periods').textContent = stats.blockedPeriods.toLocaleString();
                document.getElementById('blocked-hours').textContent = stats.blockedHours.toLocaleString();
                
                updateStatsTable(stats.bookingsData);
            }

            function displayYearlyStatistics(year) {
                const startDate = new Date(year, 0, 1);
                const endDate = new Date(year, 11, 31);
                const stats = calculateStatistics(bookings, startDate, endDate);
                
                const yearlyDisplay = document.getElementById('yearly-stats-display');
                yearlyDisplay.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-900 to-purple-800 p-6 rounded-xl border border-purple-700">
                        <h4 class="text-xl font-semibold text-purple-200 mb-2">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏µ ${year + 543}</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-purple-300">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span class="text-white font-semibold">${stats.totalBookings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-purple-300">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°:</span>
                                <span class="text-white font-semibold">${stats.totalHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-purple-300">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                <span class="text-green-300 font-semibold">${stats.actualBookings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-purple-300">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå:</span>
                                <span class="text-blue-300 font-semibold">${stats.blockedPeriods} ‡∏Ñ‡∏≤‡∏ö</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-600">
                        <h4 class="text-xl font-semibold text-slate-200 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto" id="monthly-breakdown">
                            <!-- Monthly breakdown will be populated here -->
                        </div>
                    </div>
                `;
                
                // Generate monthly breakdown
                const monthlyBreakdown = document.getElementById('monthly-breakdown');
                const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                                   '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                
                for (let month = 0; month < 12; month++) {
                    const monthStart = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0);
                    const monthStats = calculateStatistics(bookings, monthStart, monthEnd);
                    
                    if (monthStats.totalBookings > 0) {
                        monthlyBreakdown.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-slate-700 rounded">
                                <span class="text-slate-300">${monthNames[month]}</span>
                                <div class="text-right">
                                    <div class="text-white font-semibold">${monthStats.totalBookings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                                    <div class="text-slate-400 text-sm">${monthStats.totalHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                updateStatsTable(stats.bookingsData);
            }

            function displayMonthlyStatistics(month, year) {
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0);
                const stats = calculateStatistics(bookings, startDate, endDate);
                
                const monthNames = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', 
                                   '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
                
                const monthlyDisplay = document.getElementById('monthly-stats-display');
                monthlyDisplay.innerHTML = `
                    <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 p-6 rounded-xl border border-indigo-700">
                        <h4 class="text-xl font-semibold text-indigo-200 mb-2">üìÖ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥${monthNames[month]} ${year + 543}</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-indigo-300">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                                <span class="text-white font-semibold">${stats.totalBookings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-indigo-300">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°:</span>
                                <span class="text-white font-semibold">${stats.totalHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-indigo-300">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                                <span class="text-green-300 font-semibold">${stats.actualBookings} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-indigo-300">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå:</span>
                                <span class="text-blue-300 font-semibold">${stats.blockedPeriods} ‡∏Ñ‡∏≤‡∏ö</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-600">
                        <h4 class="text-xl font-semibold text-slate-200 mb-4">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h4>
                        <div class="space-y-1 max-h-64 overflow-y-auto">
                            ${stats.bookingsData.length > 0 ? 
                                stats.bookingsData.map(booking => `
                                    <div class="flex justify-between items-center p-2 bg-slate-700 rounded text-sm">
                                        <span class="text-slate-300">${new Date(booking.date).toLocaleDateString('th-TH')}</span>
                                        <span class="text-white">${countPeriodsInTimeString(booking.time)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                                    </div>
                                `).join('') 
                                : '<p class="text-slate-400 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>'
                            }
                        </div>
                    </div>
                `;
                
                updateStatsTable(stats.bookingsData);
            }

            function updateStatsTable(bookingsData) {
                const tableBody = document.getElementById('stats-table-body');
                
                if (bookingsData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</td></tr>';
                    return;
                }
                
                // Create combined data including computer class periods
                const allUsageData = [];
                
                // Add actual bookings
                bookingsData.forEach(booking => {
                    allUsageData.push({
                        date: booking.date,
                        time: booking.time || 'N/A',
                        activity: booking.activity || 'N/A',
                        teacher: booking.teacher || 'N/A',
                        hours: countPeriodsInTimeString(booking.time),
                        type: 'booking'
                    });
                });
                
                // Add computer class periods for dates that have bookings
                const uniqueDates = [...new Set(bookingsData.map(b => b.date))];
                uniqueDates.forEach(dateString => {
                    const date = new Date(dateString);
                    const dayOfWeek = date.getDay();
                    if (blockedTimeSlots[dayOfWeek]) {
                        const blockedPeriods = blockedTimeSlots[dayOfWeek].map(slotId => {
                            const slot = timeSlots.find(s => s.id === slotId);
                            return `${slot.label} (${slot.time})`;
                        }).join(', ');
                        
                        allUsageData.push({
                            date: dateString,
                            time: blockedPeriods,
                            activity: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥',
                            teacher: '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤',
                            hours: blockedTimeSlots[dayOfWeek].length,
                            type: 'computer-class'
                        });
                    }
                });
                
                tableBody.innerHTML = allUsageData
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .map(usage => `
                        <tr class="border-b border-slate-700 hover:bg-slate-800">
                            <td class="px-6 py-4">${new Date(usage.date).toLocaleDateString('th-TH')}</td>
                            <td class="px-6 py-4">${usage.time}</td>
                            <td class="px-6 py-4">${usage.activity}</td>
                            <td class="px-6 py-4">${usage.teacher}</td>
                            <td class="px-6 py-4 font-semibold">${usage.hours}</td>
                            <td class="px-6 py-4">
                                ${usage.type === 'booking' ? 
                                    '<span class="bg-green-800 text-green-200 px-2 py-1 rounded-full text-xs">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>' :
                                    '<span class="bg-blue-800 text-blue-200 px-2 py-1 rounded-full text-xs">üíª ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</span>'
                                }
                            </td>
                        </tr>
                    `).join('');
            }

            // Statistics modal event handlers
            statsBtn.addEventListener('click', () => {
                statsModal.style.display = 'flex';
                populateYearSelectors();
                displayTotalStatistics();
            });

            closeStatsModalBtn.addEventListener('click', () => {
                statsModal.style.display = 'none';
            });

            // Tab switching
            document.querySelectorAll('.stats-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update tab buttons
                    document.querySelectorAll('.stats-tab-btn').forEach(b => {
                        b.className = 'stats-tab-btn btn-secondary px-4 py-2 rounded-lg text-sm';
                    });
                    e.target.className = 'stats-tab-btn btn-primary px-4 py-2 rounded-lg text-sm';
                    
                    // Show/hide content
                    document.querySelectorAll('.stats-content').forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    const targetId = e.target.id.replace('-btn', '-content');
                    document.getElementById(targetId).classList.remove('hidden');
                    
                    // Load appropriate data
                    if (targetId === 'stats-total-content') {
                        displayTotalStatistics();
                    } else if (targetId === 'stats-yearly-content') {
                        const year = parseInt(document.getElementById('year-select').value);
                        displayYearlyStatistics(year);
                    } else if (targetId === 'stats-monthly-content') {
                        const month = parseInt(document.getElementById('month-select').value);
                        const year = parseInt(document.getElementById('monthly-year-select').value);
                        displayMonthlyStatistics(month, year);
                    }
                });
            });

            // Year and month selectors
            document.getElementById('year-select').addEventListener('change', (e) => {
                displayYearlyStatistics(parseInt(e.target.value));
            });

            document.getElementById('month-select').addEventListener('change', (e) => {
                const month = parseInt(e.target.value);
                const year = parseInt(document.getElementById('monthly-year-select').value);
                displayMonthlyStatistics(month, year);
            });

            document.getElementById('monthly-year-select').addEventListener('change', (e) => {
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(e.target.value);
                displayMonthlyStatistics(month, year);
            });

            // Close modal when clicking outside
            statsModal.addEventListener('click', (e) => {
                if (e.target === statsModal) {
                    statsModal.style.display = 'none';
                }
            });

            // Initial load
            generateTimeSlots();
            fetchBookings();
        });
    </script>
</body>
</html>
