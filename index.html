<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏° - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏Ø</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #0f172a; /* Slate 900 - Darkest Background */
            color: #cbd5e1; /* Slate 300 - Light Text */
        }
        
        @keyframes pulse-animation {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-day {
            background-color: #ffffff; /* White - Brightest Day */
            border: 1px solid #e2e8f0; /* Slate 200 */
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .calendar-day:not(.disabled):hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(56, 189, 248, 0.2), 0 4px 10px rgba(0,0,0,0.1);
            border-color: #38bdf8;
        }
        .calendar-day.disabled {
            background-color: #1e293b; /* Slate 800 - Darker Disabled Day */
            color: #64748b; /* Slate 500 */
            border-color: #334155; /* Slate 700 */
        }
        .day-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b; /* Slate 800 for white background */
        }
        .calendar-day.disabled .day-number {
            color: #64748b; /* Slate 500 for disabled background */
        }
        .booked-label {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #ffffff;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            margin-top: 4px;
            display: inline-block;
            animation: pulse-animation 2s infinite;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #38bdf8; /* Sky 400 */
            border-radius: 0.75rem;
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.2);
        }
        .form-input, .form-textarea {
            background-color: #0f172a; /* Slate 900 */
            border: 1px solid #475569; /* Slate 600 */
            color: #cbd5e1; /* Slate 300 */
            border-radius: 0.375rem;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #38bdf8; /* Sky 400 */
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
        }
        .btn-primary {
            background-color: #0ea5e9; /* Sky 500 */
            color: #ffffff;
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }
        .btn-primary:hover {
            background-color: #0284c7; /* Sky 600 */
        }
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #cbd5e1; /* Slate 300 */
            font-weight: 500;
            border: 1px solid #475569; /* Slate 600 */
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }
        .btn-secondary:hover {
             background-color: #475569; /* Slate 600 */
        }
        .time-slot-label {
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            cursor: pointer;
            border-radius: 0.375rem;
            position: relative;
        }
        .time-slot-label input:checked + span {
            background-color: #0ea5e9; /* Sky 500 */
            color: #ffffff;
            border-color: #0ea5e9;
        }
        .time-slot-label.disabled {
            background-color: #1e293b; /* Slate 800 */
            border-color: #334155; /* Slate 700 */
            cursor: not-allowed;
        }
        .time-slot-label.disabled span {
            color: #64748b; /* Slate 500 */
            text-decoration: line-through;
        }
        
        .time-slot-label.blocked {
            background-color: #7c2d12; /* Red 900 */
            border-color: #991b1b; /* Red 800 */
            cursor: not-allowed;
        }
        
        .time-slot-label.blocked span {
            color: #fca5a5; /* Red 300 */
            text-decoration: line-through;
        }
        
        .time-slot-label.blocked::after {
            content: 'üö´';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
        }
        
        /* Loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Success animations */
        @keyframes success-bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -8px, 0); }
            70% { transform: translate3d(0, -4px, 0); }
            90% { transform: translate3d(0, -2px, 0); }
        }
        
        .success-animation {
            animation: success-bounce 1s ease;
        }
        
        /* Improved form styling */
        .form-group {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            transition: all 0.3s ease;
        }
        
        .form-input:focus + label,
        .form-textarea:focus + label {
            color: #38bdf8;
        }
        
        /* Better mobile responsiveness */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                font-size: 0.875rem;
            }
            
            .day-number {
                font-size: 1rem;
            }
            
            .booked-label {
                font-size: 0.625rem;
                padding: 2px 6px;
            }
        }
        
        /* Enhanced modal */
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            backdrop-filter: blur(10px);
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-spinner" class="fixed inset-0 bg-slate-900 bg-opacity-70 flex justify-center items-center z-50 backdrop-blur-sm">
        <div class="text-center">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-sky-500 mx-auto mb-4"></div>
            <p class="text-slate-300 text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            <div class="mt-2 text-slate-400 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 p-4">
            <div class="mb-4">
                <div class="text-6xl mb-2">üìö</div>
                <h1 class="text-3xl md:text-5xl font-bold text-sky-400" style="text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°</h1>
                <p class="text-lg md:text-xl text-slate-400 mt-2">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå‡∏Ø</p>
                <div class="flex justify-center items-center flex-wrap gap-3 mt-4 text-slate-500 text-xs">
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-white rounded border"></div>
                        <span>‡∏ß‡πà‡∏≤‡∏á</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-500 rounded"></div>
                        <span>‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-red-900 rounded"></div>
                        <span>‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <div class="w-3 h-3 bg-slate-600 rounded"></div>
                        <span>‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Actions -->
        <div class="mb-6 flex flex-col md:flex-row gap-4 justify-center items-center">
            <div class="flex gap-2">
                <button id="today-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button id="refresh-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <div class="flex items-center gap-2 w-full md:w-auto">
                <input type="text" id="search-bookings" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á..." class="form-input px-3 py-2 w-full md:w-48 rounded-lg text-sm">
                <button id="clear-search" class="btn-secondary px-3 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
        </div>

        <main id="calendar-container" class="p-6 rounded-xl bg-slate-900/50 border border-slate-700" style="box-shadow: 0 0 20px rgba(56, 189, 248, 0.15);">
            <div class="flex justify-between items-center mb-6">
                <button id="prev-month" class="p-3 rounded-full hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="month-year" class="text-2xl md:text-3xl font-bold text-slate-300"></h2>
                <button id="next-month" class="p-3 rounded-full hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div class="calendar-grid text-center font-semibold text-slate-400 mb-2">
                <div>‡∏≠‡∏≤.</div><div>‡∏à.</div><div>‡∏≠.</div><div>‡∏û.</div><div>‡∏û‡∏§.</div><div>‡∏®.</div><div>‡∏™.</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </main>
    </div>

    <!-- Main Modal for Booking and Details -->
    <div id="main-modal" class="fixed inset-0 z-40 hidden items-center justify-center p-2 md:p-4 modal-backdrop">
        <div class="modal-content p-4 md:p-6 w-full max-w-3xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl md:text-2xl font-bold text-slate-200 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="modal-date-display"></span></h3>
            
            <div id="existing-bookings-container" class="mb-6">
                <h4 class="text-xl text-slate-300 mb-2 border-b-2 border-slate-600 pb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>
                <div id="existing-bookings-list" class="space-y-3 max-h-40 overflow-y-auto p-1"></div>
            </div>

            <div id="booking-form-container">
                 <h4 class="text-xl text-slate-300 mb-2 border-b-2 border-slate-600 pb-1">‡∏à‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                 <div id="blocked-info" class="mb-4 p-3 bg-amber-900/30 border border-amber-700 rounded-lg text-amber-200 text-sm hidden">
                    <p class="font-semibold mb-1">‚ö†Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</p>
                    <div id="blocked-periods-list"></div>
                 </div>
                <form id="booking-form" class="mt-4">
                    <div class="mb-4">
                        <label class="block text-lg text-slate-400 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="time-slots-container"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 my-4">
                        <button type="button" id="select-all-day" class="btn-secondary p-2 text-sm">‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</button>
                        <button type="button" id="select-morning" class="btn-secondary p-2 text-sm">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ä‡πâ‡∏≤</button>
                        <button type="button" id="select-afternoon" class="btn-secondary p-2 text-sm">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡πà‡∏≤‡∏¢</button>
                        <button type="button" id="clear-selection" class="btn-secondary p-2 text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    </div>
                     <div class="mb-4">
                        <label for="custom-time" class="block text-lg text-slate-400 mb-2">‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á</label>
                        <input type="text" id="custom-time" name="custom-time" class="form-input w-full p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô 9.00-11.30 ‡∏ô.">
                    </div>
                    <div class="form-group">
                        <label for="activity" class="block text-lg text-slate-400 mb-2">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° *</label>
                        <textarea id="activity" name="activity" rows="3" class="form-textarea w-full p-3 rounded-lg" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå, ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="teacher" class="block text-lg text-slate-400 mb-2">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• *</label>
                        <input type="text" id="teacher" name="teacher" class="form-input w-full p-3 rounded-lg" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
                    </div>
                    <div class="form-group">
                        <label for="students" class="block text-lg text-slate-400 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô *</label>
                        <input type="text" id="students" name="students" class="form-input w-full p-3 rounded-lg" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 25 ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏°.1/1">
                    </div>
                    <div class="form-group">
                        <label for="contact" class="block text-lg text-slate-400 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <input type="tel" id="contact" name="contact" class="form-input w-full p-3 rounded-lg" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö">
                    </div>
                    <input type="hidden" id="selected-date-input" name="date">
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="submit" id="submit-booking" class="btn-primary py-2 px-6">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                    </div>
                </form>
            </div>
             <div id="fully-booked-message" class="hidden text-center p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                <p class="font-bold text-lg text-amber-300">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ</p>
            </div>

            <div class="flex justify-end mt-6">
                 <button type="button" id="close-main-modal" class="btn-secondary py-2 px-6">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_eAL5kFkyv95qfLO8KynwJ9Jig1DMw8qMuTzMYfjrWPjePXf520GQRAEKnqtkv_OzLw/exec';
            
            const monthYearEl = document.getElementById('month-year');
            const calendarBody = document.getElementById('calendar-body');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const loadingSpinner = document.getElementById('loading-spinner');

            const mainModal = document.getElementById('main-modal');
            const modalDateDisplay = document.getElementById('modal-date-display');
            const closeMainModalBtn = document.getElementById('close-main-modal');
            
            const existingBookingsContainer = document.getElementById('existing-bookings-container');
            const existingBookingsList = document.getElementById('existing-bookings-list');
            const bookingFormContainer = document.getElementById('booking-form-container');
            const fullyBookedMessage = document.getElementById('fully-booked-message');

            const bookingForm = document.getElementById('booking-form');
            const selectedDateInput = document.getElementById('selected-date-input');
            
            let currentMonthDate = new Date();
            let bookings = [];
            let isSubmitting = false;

            // Notification system
            function showNotification(message, type = 'success', duration = 5000) {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
                    </div>
                `;
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }

            // Form validation
            function validateForm() {
                const activity = document.getElementById('activity').value.trim();
                const teacher = document.getElementById('teacher').value.trim();
                const students = document.getElementById('students').value.trim();
                const selectedTimes = document.querySelectorAll('#time-slots-container input[type="checkbox"]:checked');
                const customTime = document.getElementById('custom-time').value.trim();

                if (!activity) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'error');
                    return false;
                }
                if (!teacher) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
                    return false;
                }
                if (!students) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
                    return false;
                }
                if (selectedTimes.length === 0 && !customTime) {
                    showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á', 'error');
                    return false;
                }
                return true;
            }

            // Save form data to localStorage
            function saveFormData() {
                const formData = {
                    activity: document.getElementById('activity').value,
                    teacher: document.getElementById('teacher').value,
                    students: document.getElementById('students').value,
                    contact: document.getElementById('contact').value
                };
                localStorage.setItem('bookingFormData', JSON.stringify(formData));
            }

            // Load form data from localStorage
            function loadFormData() {
                const saved = localStorage.getItem('bookingFormData');
                if (saved) {
                    const data = JSON.parse(saved);
                    document.getElementById('activity').value = data.activity || '';
                    document.getElementById('teacher').value = data.teacher || '';
                    document.getElementById('students').value = data.students || '';
                    document.getElementById('contact').value = data.contact || '';
                }
            }

            const timeSlots = [
                { id: 't1', label: '‡∏Ñ‡∏≤‡∏ö 1', time: '8:30-9:20' },
                { id: 't2', label: '‡∏Ñ‡∏≤‡∏ö 2', time: '9:20-10:10' },
                { id: 't3', label: '‡∏Ñ‡∏≤‡∏ö 3', time: '10:10-11:00' },
                { id: 't4', label: '‡∏Ñ‡∏≤‡∏ö 4', time: '11:00-12:00' },
                { id: 't5', label: '‡∏Ñ‡∏≤‡∏ö 5', time: '12:00-12:50' },
                { id: 't6', label: '‡∏Ñ‡∏≤‡∏ö 6', time: '12:50-13:40' },
                { id: 't7', label: '‡∏Ñ‡∏≤‡∏ö 7', time: '13:40-14:30' },
                { id: 't8', label: '‡∏Ñ‡∏≤‡∏ö 8', time: '14:30-15:20' },
                { id: 't9', label: '‡∏Ñ‡∏≤‡∏ö 9', time: '15:20-16:10' },
                { id: 't10', label: '‡∏Ñ‡∏≤‡∏ö 10', time: '16:10-17:00' },
            ];

            // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const blockedTimeSlots = {
                1: ['t7', 't8'], // ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå: ‡∏Ñ‡∏≤‡∏ö 7-8
                2: ['t1', 't2', 't5', 't6', 't7', 't8'], // ‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£: ‡∏Ñ‡∏≤‡∏ö 1-2 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 5-8
                3: ['t6', 't7', 't9', 't10'], // ‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò: ‡∏Ñ‡∏≤‡∏ö 6-7 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 9-10
                5: ['t1', 't2', 't3', 't7', 't8', 't9'] // ‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå: ‡∏Ñ‡∏≤‡∏ö 1-3 ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏≤‡∏ö 7-9
            };

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            function isTimeSlotBlocked(date, slotId) {
                const dayOfWeek = new Date(date).getDay();
                return blockedTimeSlots[dayOfWeek] && blockedTimeSlots[dayOfWeek].includes(slotId);
            }

            function generateTimeSlots() {
                const container = document.getElementById('time-slots-container');
                container.innerHTML = '';
                timeSlots.forEach(slot => {
                    const label = document.createElement('label');
                    label.className = 'time-slot-label block rounded-md text-center p-2';
                    label.innerHTML = `
                        <input type="checkbox" name="time" value="${slot.label} (${slot.time})" class="hidden">
                        <span class="block w-full h-full p-2 rounded-md transition-colors">${slot.label}<br>${slot.time}</span>
                    `;
                    container.appendChild(label);
                });
            }

            // Cache for bookings
            let bookingsCache = null;
            let lastFetchTime = 0;
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            async function fetchBookings(forceRefresh = false) {
                const now = Date.now();
                
                // Use cache if available and not expired
                if (!forceRefresh && bookingsCache && (now - lastFetchTime) < CACHE_DURATION) {
                    bookings = bookingsCache;
                    renderCalendar(currentMonthDate);
                    return;
                }

                loadingSpinner.style.display = 'flex';
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                    const response = await fetch(`${SCRIPT_URL}?t=${now}`, {
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    if (result.status === "success") {
                        bookings = result.data || [];
                        bookingsCache = bookings;
                        lastFetchTime = now;
                    } else {
                        throw new Error(result.message || 'Failed to parse bookings.');
                    }
                    renderCalendar(currentMonthDate);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showNotification('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error', 7000);
                    } else {
                        console.error('Error fetching bookings:', error);
                        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error', 7000);
                    }
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            }

            function getBookingSummary(bookingsForDay) {
                if (!bookingsForDay || bookingsForDay.length === 0) {
                    return '';
                }

                // Filter bookings based on search query
                let filteredBookings = bookingsForDay;
                if (searchQuery) {
                    filteredBookings = bookingsForDay.filter(b => 
                        (b.activity && b.activity.toLowerCase().includes(searchQuery)) ||
                        (b.teacher && b.teacher.toLowerCase().includes(searchQuery)) ||
                        (b.students && b.students.toLowerCase().includes(searchQuery)) ||
                        (b.time && b.time.toLowerCase().includes(searchQuery))
                    );
                }

                if (filteredBookings.length === 0 && searchQuery) {
                    return '';
                }

                const allBookedTimes = bookingsForDay.flatMap(b => b.time ? b.time.split(',').map(t => t.trim()) : []);

                if (allBookedTimes.some(t => t.toLowerCase().includes('‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'))) {
                    return searchQuery && filteredBookings.length === 0 ? '' : '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)';
                }
                
                const periodRegex = /‡∏Ñ‡∏≤‡∏ö\s*\d+/g;
                let totalPeriods = 0;
                const seenPeriods = new Set();

                allBookedTimes.forEach(timeString => {
                    const matches = timeString.match(periodRegex);
                    if (matches) {
                        matches.forEach(match => {
                            if (!seenPeriods.has(match)) {
                                seenPeriods.add(match);
                                totalPeriods++;
                            }
                        });
                    }
                });

                if (totalPeriods > 0) {
                    return searchQuery && filteredBookings.length === 0 ? '' : `‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (${totalPeriods} ‡∏Ñ‡∏≤‡∏ö)`;
                }

                if (allBookedTimes.length > 0) {
                    return searchQuery && filteredBookings.length === 0 ? '' : '‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'; // Fallback for custom times
                }

                return '';
            }

            function renderCalendar(date) {
                calendarBody.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                monthYearEl.textContent = `${date.toLocaleString('th-TH', { month: 'long' })} ${year + 543}`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                prevMonthBtn.disabled = (new Date(year, month, 1) <= new Date(today.getFullYear(), today.getMonth(), 1));

                for (let i = 0; i < firstDay; i++) {
                    calendarBody.appendChild(document.createElement('div')).className = 'calendar-day disabled';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    const currentDate = new Date(year, month, i);
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    
                    dayEl.className = 'calendar-day p-2 flex flex-col items-start justify-start cursor-pointer';
                    dayEl.dataset.date = dateString;
                    
                    let dayContent = `<span class="day-number">${i}</span>`;
                    const bookingsForDay = bookings.filter(b => b.date === dateString);
                    
                    const summary = getBookingSummary(bookingsForDay);
                    if (summary) {
                        dayContent += `<div class="booked-label">${summary}</div>`;
                    }

                    dayEl.innerHTML = dayContent;
                    
                    if (currentDate < today) {
                        dayEl.classList.add('disabled');
                        dayEl.classList.remove('cursor-pointer');
                    } else {
                        dayEl.addEventListener('click', () => openMainModal(dateString));
                    }
                    calendarBody.appendChild(dayEl);
                }
            }
            
            function openMainModal(dateString) {
                const [y, m, d] = dateString.split('-');
                const dateObj = new Date(y, m - 1, d);
                modalDateDisplay.textContent = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
                selectedDateInput.value = dateString;
                bookingForm.reset();
                loadFormData(); // Load saved form data

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô
                const dayOfWeek = dateObj.getDay();
                const blockedInfo = document.getElementById('blocked-info');
                const blockedPeriodsList = document.getElementById('blocked-periods-list');
                
                if (blockedTimeSlots[dayOfWeek]) {
                    const blockedPeriods = blockedTimeSlots[dayOfWeek].map(slotId => {
                        const slot = timeSlots.find(s => s.id === slotId);
                        return `${slot.label} (${slot.time})`;
                    }).join(', ');
                    
                    blockedPeriodsList.textContent = blockedPeriods;
                    blockedInfo.classList.remove('hidden');
                } else {
                    blockedInfo.classList.add('hidden');
                }

                const bookingsForDay = bookings.filter(b => b.date === dateString);
                const isFullyBooked = bookingsForDay.some(b => b.time && b.time.toLowerCase().includes('‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'));

                const bookedTimeValues = bookingsForDay
                    .flatMap(b => (b.time ? b.time.split(',').map(t => t.trim()) : []));

                document.querySelectorAll('#time-slots-container input[type="checkbox"]').forEach((checkbox, index) => {
                    const label = checkbox.parentElement;
                    const slotId = timeSlots[index].id;
                    const isBlocked = isTimeSlotBlocked(dateString, slotId);
                    const isBooked = bookedTimeValues.includes(checkbox.value);
                    
                    // Reset classes
                    label.classList.remove('disabled', 'blocked');
                    
                    if (isBlocked) {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                        checkbox.disabled = true;
                        checkbox.checked = false;
                        label.classList.add('blocked');
                    } else if (isBooked) {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                        checkbox.disabled = true;
                        checkbox.checked = false; 
                        label.classList.add('disabled');
                    } else {
                        // ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á
                        checkbox.disabled = false;
                        checkbox.checked = false;
                    }
                });

                if (bookingsForDay.length > 0) {
                    existingBookingsList.innerHTML = bookingsForDay.map(b => `
                        <div class="p-3 rounded-lg border border-slate-700 bg-slate-800 text-sm">
                            <p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${b.time || 'N/A'}</p>
                            <p><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${b.activity || 'N/A'}</p>
                            <p><strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</strong> ${b.teacher || 'N/A'}</p>
                        </div>
                    `).join('');
                    existingBookingsContainer.style.display = 'block';
                } else {
                    existingBookingsList.innerHTML = '<p class="text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>';
                    existingBookingsContainer.style.display = 'block';
                }

                if (isFullyBooked) {
                    bookingFormContainer.style.display = 'none';
                    fullyBookedMessage.style.display = 'block';
                } else {
                    bookingFormContainer.style.display = 'block';
                    fullyBookedMessage.style.display = 'none';
                }

                mainModal.style.display = 'flex';
            }

            closeMainModalBtn.addEventListener('click', () => mainModal.style.display = 'none');

            prevMonthBtn.addEventListener('click', () => {
                currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
                renderCalendar(currentMonthDate);
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
                renderCalendar(currentMonthDate);
            });

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Prevent double submission
                if (isSubmitting) return;
                isSubmitting = true;
                
                // Validate form
                if (!validateForm()) {
                    isSubmitting = false;
                    return;
                }
                
                // Save form data for future use
                saveFormData();
                
                loadingSpinner.style.display = 'flex';
                
                const formData = new FormData(bookingForm);
                const selectedTimes = formData.getAll('time');
                const customTime = formData.get('custom-time').trim();

                let timeString = selectedTimes.join(', ');
                if (customTime) {
                    timeString = timeString ? `${timeString}, ${customTime}` : customTime;
                }

                const urlEncodedData = new URLSearchParams();
                urlEncodedData.append('date', formData.get('date'));
                urlEncodedData.append('time', timeString);
                urlEncodedData.append('activity', formData.get('activity'));
                urlEncodedData.append('teacher', formData.get('teacher'));
                urlEncodedData.append('students', formData.get('students'));
                urlEncodedData.append('contact', formData.get('contact') || '');

                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: urlEncodedData,
                    });
                    
                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    
                    const result = await response.json();
                    if (result.status !== 'success') {
                         throw new Error(result.message || 'Failed to submit booking.');
                    }

                    showNotification('‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! üéâ', 'success');
                    mainModal.style.display = 'none';
                    document.getElementById('calendar-container').classList.add('success-animation');
                    setTimeout(() => {
                        document.getElementById('calendar-container').classList.remove('success-animation');
                    }, 1000);
                    await fetchBookings(true);

                } catch (error) {
                    console.error('Error submitting booking:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error', 7000);
                } finally {
                    loadingSpinner.style.display = 'none';
                    isSubmitting = false;
                }
            });

            // Button helpers
            document.getElementById('select-all-day').addEventListener('click', () => {
                document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach(cb => cb.checked = true);
            });
            document.getElementById('select-morning').addEventListener('click', () => {
                const morningSlots = ['t1', 't2', 't3', 't4'];
                document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach((cb, index) => {
                   if(morningSlots.includes(timeSlots[index].id)) {
                       cb.checked = true;
                   }
                });
            });
            document.getElementById('select-afternoon').addEventListener('click', () => {
                 const afternoonSlots = ['t6', 't7', 't8', 't9'];
                 document.querySelectorAll('#time-slots-container input:not(:disabled)').forEach((cb, index) => {
                    if(afternoonSlots.includes(timeSlots[index].id)) {
                       cb.checked = true;
                   }
                });
            });
            document.getElementById('clear-selection').addEventListener('click', () => {
                document.querySelectorAll('#time-slots-container input').forEach(cb => cb.checked = false);
            });

            // Search functionality
            let searchQuery = '';
            document.getElementById('search-bookings').addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderCalendar(currentMonthDate);
            });

            document.getElementById('clear-search').addEventListener('click', () => {
                document.getElementById('search-bookings').value = '';
                searchQuery = '';
                renderCalendar(currentMonthDate);
            });

            // Quick action buttons
            document.getElementById('today-btn').addEventListener('click', () => {
                currentMonthDate = new Date();
                renderCalendar(currentMonthDate);
            });

            document.getElementById('refresh-btn').addEventListener('click', () => {
                showNotification('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'success', 2000);
                fetchBookings(true); // Force refresh
            });

            // Auto-save form data while typing
            ['activity', 'teacher', 'students', 'contact'].forEach(fieldId => {
                document.getElementById(fieldId).addEventListener('input', () => {
                    setTimeout(saveFormData, 500); // Debounce save
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'r':
                            e.preventDefault();
                            fetchBookings();
                            break;
                        case 'f':
                            e.preventDefault();
                            document.getElementById('search-bookings').focus();
                            break;
                    }
                }
                if (e.key === 'Escape' && mainModal.style.display === 'flex') {
                    mainModal.style.display = 'none';
                }
            });

            // Show app install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Show install button if needed
            });

            // Handle offline/online status
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success', 3000);
                    fetchBookings(true);
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏ä', 'error', 5000);
                }
            }

            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);

            // Auto-refresh data every 10 minutes
            setInterval(() => {
                if (navigator.onLine) {
                    fetchBookings();
                }
            }, 10 * 60 * 1000);

            // Initial load
            generateTimeSlots();
            fetchBookings();
        });
    </script>
</body>
</html>
